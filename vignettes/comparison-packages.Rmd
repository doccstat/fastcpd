---
title: "Comparison with other R packages"
output: rmarkdown::html_vignette
description: |
  Speed and result comparison with other R packages.
vignette: >
  %\VignetteIndexEntry{Comparison with other R packages}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, comment = "#>", eval = TRUE, cache = FALSE,
  warning = FALSE, fig.width = 8, fig.height = 5
)
```

# Data setup

## Univariate mean change

```{r data-setup-univariate-mean-change}
# Univariate mean change
set.seed(1)
p <- 1
mean_data_1 <- rbind(
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(100, p)),
  mvtnorm::rmvnorm(400, mean = rep(50, p), sigma = diag(100, p)),
  mvtnorm::rmvnorm(300, mean = rep(2, p), sigma = diag(100, p))
)

plot.ts(mean_data_1)
```

## Univariate mean and/or variance change

```{r data-setup-univariate-mean-and-or-variance-change}
# Univariate mean and/or variance change
set.seed(1)
p <- 1
mv_data_1 <- rbind(
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(400, mean = rep(10, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(50, p)),
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(400, mean = rep(10, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(300, mean = rep(10, p), sigma = diag(50, p))
)

plot.ts(mv_data_1)
```

## Multivariate mean change

```{r data-setup-multivariate-mean-change}
# Multivariate mean change
set.seed(1)
p <- 3
mean_data_3 <- rbind(
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(100, p)),
  mvtnorm::rmvnorm(400, mean = rep(50, p), sigma = diag(100, p)),
  mvtnorm::rmvnorm(300, mean = rep(2, p), sigma = diag(100, p))
)

plot.ts(mean_data_3)
```

## Multivariate mean and/or variance change

```{r data-setup-multivariate-mean-and-or-variance-change}
# Multivariate mean and/or variance change
set.seed(1)
p <- 3
mv_data_3 <- rbind(
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(400, mean = rep(10, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(50, p)),
  mvtnorm::rmvnorm(300, mean = rep(0, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(400, mean = rep(10, p), sigma = diag(1, p)),
  mvtnorm::rmvnorm(300, mean = rep(10, p), sigma = diag(50, p))
)

plot.ts(mv_data_3)
```

## Linear regression

```{r data-setup-linear-regression}
# Linear regression
set.seed(1)
n <- 300
p <- 4
x <- mvtnorm::rmvnorm(n, rep(0, p), diag(p))
theta_0 <- rbind(c(1, 3.2, -1, 0), c(-1, -0.5, 2.5, -2), c(0.8, 0, 1, 2))
y <- c(
  x[1:100, ] %*% theta_0[1, ] + rnorm(100, 0, 3),
  x[101:200, ] %*% theta_0[2, ] + rnorm(100, 0, 3),
  x[201:n, ] %*% theta_0[3, ] + rnorm(100, 0, 3)
)
lm_data <- data.frame(y = y, x = x)

plot.ts(lm_data)
```

## Logistic regression

```{r data-setup-logistic-regression}
# Logistic regression
set.seed(1)
n <- 500
p <- 4
x <- mvtnorm::rmvnorm(n, rep(0, p), diag(p))
theta <- rbind(rnorm(p, 0, 1), rnorm(p, 2, 1))
y <- c(
  rbinom(300, 1, 1 / (1 + exp(-x[1:300, ] %*% theta[1, ]))),
  rbinom(200, 1, 1 / (1 + exp(-x[301:n, ] %*% theta[2, ])))
)
binomial_data <- data.frame(y = y, x = x)

plot.ts(binomial_data)
```

## Poisson regression

```{r data-setup-poisson-regression}
# Poisson regression
set.seed(1)
n <- 1100
p <- 3
x <- mvtnorm::rmvnorm(n, rep(0, p), diag(p))
delta <- rnorm(p)
theta_0 <- c(1, 0.3, -1)
y <- c(
  rpois(500, exp(x[1:500, ] %*% theta_0)),
  rpois(300, exp(x[501:800, ] %*% (theta_0 + delta))),
  rpois(200, exp(x[801:1000, ] %*% theta_0)),
  rpois(100, exp(x[1001:1100, ] %*% (theta_0 - delta)))
)
poisson_data <- data.frame(y = y, x = x)

plot.ts(log(poisson_data$y))
plot.ts(poisson_data[, -1])
```

## Lasso

```{r data-setup-lasso}
# Lasso
set.seed(1)
n <- 480
p_true <- 6
p <- 50
x <- mvtnorm::rmvnorm(n, rep(0, p), diag(p))
theta_0 <- rbind(
  runif(p_true, -5, -2),
  runif(p_true, -3, 3),
  runif(p_true, 2, 5),
  runif(p_true, -5, 5)
)
theta_0 <- cbind(theta_0, matrix(0, ncol = p - p_true, nrow = 4))
y <- c(
  x[1:80, ] %*% theta_0[1, ] + rnorm(80, 0, 1),
  x[81:200, ] %*% theta_0[2, ] + rnorm(120, 0, 1),
  x[201:320, ] %*% theta_0[3, ] + rnorm(120, 0, 1),
  x[321:n, ] %*% theta_0[4, ] + rnorm(160, 0, 1)
)
lasso_data <- data.frame(y = y, x = x)

plot.ts(lasso_data[, seq_len(p_true + 1)])
```

## AR(3)

```{r data-setup-ar3}
# AR(3)
set.seed(1)
n <- 1000
x <- rep(0, n + 3)
for (i in 1:600) {
  x[i + 3] <- 0.6 * x[i + 2] - 0.2 * x[i + 1] + 0.1 * x[i] + rnorm(1, 0, 3)
}
for (i in 601:1000) {
  x[i + 3] <- 0.3 * x[i + 2] + 0.4 * x[i + 1] + 0.2 * x[i] + rnorm(1, 0, 3)
}
ar_data <- x[-seq_len(3)]

plot.ts(ar_data)
```

## GARCH(1, 1)

```{r data-setup-garch11}
# GARCH(1, 1)
set.seed(1)
n <- 400
sigma_2 <- rep(1, n + 1)
x <- rep(0, n + 1)
for (i in seq_len(200)) {
  sigma_2[i + 1] <- 20 + 0.5 * x[i]^2 + 0.1 * sigma_2[i]
  x[i + 1] <- rnorm(1, 0, sqrt(sigma_2[i + 1]))
}
for (i in 201:400) {
  sigma_2[i + 1] <- 1 + 0.1 * x[i]^2 + 0.5 * sigma_2[i]
  x[i + 1] <- rnorm(1, 0, sqrt(sigma_2[i + 1]))
}
garch_data <- x[-1]

plot.ts(garch_data)
```

## VAR(2)

```{r data-setup-var2}
# VAR(2)
set.seed(1)
n <- 800
p <- 2
theta_1 <- matrix(c(-0.3, 0.6, -0.5, 0.4, 0.2, 0.2, 0.2, -0.2), nrow = p)
theta_2 <- matrix(c(0.3, -0.4, 0.1, -0.5, -0.5, -0.2, -0.5, 0.2), nrow = p)
x <- matrix(0, n + 2, p)
for (i in 1:500) {
  x[i + 2, ] <- theta_1 %*% c(x[i + 1, ], x[i, ]) + rnorm(p, 0, 1)
}
for (i in 501:n) {
  x[i + 2, ] <- theta_2 %*% c(x[i + 1, ], x[i, ]) + rnorm(p, 0, 1)
}
var_data <- x[-seq_len(2), ]

plot.ts(var_data)
```

# Univariate mean change

The true change points are 300 and 700.
Some methods are plotted due to the un-retrievable change points.

```{r univariate-mean-change-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.mean(mean_data_1, r.progress = FALSE)@cp_set)
```

```{r univariate-mean-change-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(300, 700))
```

```{r univariate-mean-change-CptNonPar}
(CptNonPar_result <- CptNonPar::np.mojo(mean_data_1, G = floor(length(mean_data_1) / 6))$cpts)
```

```{r univariate-mean-change-CptNonPar-testthat, include = FALSE}
testthat::expect_equal(CptNonPar_result, c(300, 700))
```

```{r univariate-mean-change-strucchange, eval = FALSE}
strucchange::breakpoints(y ~ 1, data = data.frame(y = mean_data_1))$breakpoints
#> [1] 300 700
```

```{r univariate-mean-change-ecp, eval = FALSE}
ecp::e.divisive(mean_data_1)$estimates
#> [1]    1  301  701 1001
```

```{r univariate-mean-change-changepoint}
(changepoint_result <- changepoint::cpt.mean(c(mean_data_1))@cpts)
```

```{r univariate-mean-change-changepoint-testthat, include = FALSE}
testthat::expect_equal(changepoint_result, c(300, 1000))
```

```{r univariate-mean-change-breakfast}
(breakfast_result <- breakfast::breakfast(mean_data_1)$cptmodel.list[[6]]$cpts)
```

```{r univariate-mean-change-breakfast-testthat, include = FALSE}
testthat::expect_equal(breakfast_result, c(300, 700))
```

```{r univariate-mean-change-wbs}
(wbs_result <- wbs::wbs(mean_data_1)$cpt$cpt.ic$mbic.penalty)
```

```{r univariate-mean-change-wbs-testthat, include = FALSE}
testthat::expect_equal(wbs_result, c(300, 700))
```

```{r univariate-mean-change-mosum, eval = FALSE}
mosum::mosum(c(mean_data_1), G = 40)$cpts.info$cpts
#> [1] 300 700
```

```{r univariate-mean-change-fpop}
(fpop_result <- fpop::Fpop(mean_data_1, nrow(mean_data_1))$t.est)
```

```{r univariate-mean-change-fpop-testthat, include = FALSE}
testthat::expect_equal(fpop_result, c(300, 700, 1000))
```

```{r univariate-mean-change-gfpop, eval = FALSE}
gfpop::gfpop(
  data = mean_data_1,
  mygraph = gfpop::graph(
    penalty = 2 * log(nrow(mean_data_1)) * gfpop::sdDiff(mean_data_1) ^ 2,
    type = "updown"
  ),
  type = "mean"
)$changepoints
#> [1]  300  700 1000
```

```{r univariate-mean-change-InspectChangepoint, eval = FALSE}
invisible(
  suppressMessages(
    capture.output(
      result_InspectChangepoint <- InspectChangepoint::inspect(
        t(mean_data_1),
        threshold = InspectChangepoint::compute.threshold(
          nrow(mean_data_1), ncol(mean_data_1)
        )
      )
    )
  )
)
result_InspectChangepoint$changepoints[, "location"]
#> [1] 300 700
```

```{r univariate-mean-change-jointseg}
(jointseg_result <- jointseg::jointSeg(mean_data_1, K = 2)$bestBkp)
```

```{r univariate-mean-change-jointseg-testthat, include = FALSE}
testthat::expect_equal(jointseg_result, c(300, 700))
```

```{r univariate-mean-change-Rbeast, eval = FALSE}
Rbeast::beast(
  mean_data_1, season = "none", print.progress = FALSE, quiet = TRUE
)$trend$cp
#>  [1] 701 301 NaN NaN NaN NaN NaN NaN NaN NaN
```

```{r univariate-mean-change-stepR}
(stepR_result <- stepR::stepFit(mean_data_1, alpha = 0.5)$rightEnd)
```

```{r univariate-mean-change-stepR-testthat, include = FALSE}
testthat::expect_equal(stepR_result, c(300, 700, 1000))
```

```{r univariate-mean-change-cpm}
(cpm_result <- cpm::processStream(mean_data_1, cpmType = "Student")$changePoints)
```

```{r univariate-mean-change-cpm-testthat, include = FALSE}
testthat::expect_equal(cpm_result, c(299, 699))
```

```{r univariate-mean-change-segmented}
(segmented_result <- segmented::segmented(
  lm(y ~ 1 + x, data.frame(y = mean_data_1, x = seq_len(nrow(mean_data_1)))),
  seg.Z = ~ x
)$psi[, "Est."])
```

```{r univariate-mean-change-segmented-testthat, include = FALSE}
testthat::expect_equal(segmented_result, c(495))
```

```{r univariate-mean-change-mcp, eval = FALSE}
plot(
  mcp::mcp(
    list(y ~ 1, ~ 1, ~ 1),
    data = data.frame(y = mean_data_1, x = seq_len(nrow(mean_data_1))),
    par_x = "x"
  )
)
```

![`mcp` plot for univariate mean change](comparison-packages-mean_data_1-mcp.svg)

```{r univariate-mean-change-not}
plot(not::not(mean_data_1, contrast = "pcwsConstMean"))
```

```{r univariate-mean-change-bcp, eval = FALSE}
plot(bcp::bcp(mean_data_1))
```

![`bcp` plot for univariate mean change](comparison-packages-mean_data_1-bcp.svg)

# Univariate mean and/or variance change

The true change points are 300, 700, 1000, 1300 and 1700.
Some methods are plotted due to the un-retrievable change points.

```{r univariate-mean-and-or-variance-change-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.mv(mv_data_1, r.progress = FALSE)@cp_set)
```

```{r univariate-mean-and-or-variance-change-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(300, 700, 1000, 1300, 1700))
```

```{r univariate-mean-and-or-variance-change-ecp, eval = FALSE}
ecp::e.divisive(mv_data_1)$estimates
#> [1]    1  301  701 1001 1301 1701 2001
```

```{r univariate-mean-and-or-variance-change-changepoint}
(changepoint_result <- changepoint::cpt.meanvar(c(mv_data_1))@cpts)
```

```{r univariate-mean-and-or-variance-change-changepoint-testthat, include = FALSE}
testthat::expect_equal(changepoint_result, c(300, 2000))
```

```{r univariate-mean-and-or-variance-change-CptNonPar}
(CptNonPar_result <- CptNonPar::np.mojo(mv_data_1, G = floor(length(mv_data_1) / 6))$cpts)
```

```{r univariate-mean-and-or-variance-change-CptNonPar-testthat, include = FALSE}
testthat::expect_equal(CptNonPar_result, c(333, 700, 1300))
```

```{r univariate-mean-and-or-variance-change-cpm}
(cpm_result <- cpm::processStream(mv_data_1, cpmType = "GLR")$changePoints)
```

```{r univariate-mean-and-or-variance-change-cpm-testthat, include = FALSE}
testthat::expect_equal(cpm_result, c(293, 300, 403, 408, 618, 621, 696, 1000, 1021, 1024, 1293, 1300, 1417, 1693, 1981))
```

```{r univariate-mean-and-or-variance-change-InspectChangepoint, eval = FALSE}
invisible(
  suppressMessages(
    capture.output(
      result_InspectChangepoint <- InspectChangepoint::inspect(
        t(mv_data_1),
        threshold = InspectChangepoint::compute.threshold(
          nrow(mv_data_1), ncol(mv_data_1)
        )
      )
    )
  )
)
result_InspectChangepoint$changepoints[, "location"]
#>   [1]  300  700  702  704  708  712  715  716  717  718  721  722  723  726  727
#>  [16]  732  734  736  740  742  744  746  748  750  753  755  756  757  759  764
#>  [31]  765  768  771  772  774  791  794  798  799  801  802  803  807  809  810
#>  [46]  813  815  817  819  826  827  828  829  831  833  835  836  837  838  840
#>  [61]  841  842  843  845  848  849  852  854  860  862  864  866  868  870  872
#>  [76]  875  879  881  884  886  887  888  889  896  897  898  899  901  912  913
#>  [91]  915  919  922  923  927  932  934  936  940  944  945  947  948  949  958
#> [106]  959  961  962  963  964  966  967  968  972  974  976  978  979 1300 1700
#> [121] 1702 1703 1704 1708 1710 1712 1714 1716 1717 1718 1721 1723 1725 1726 1731
#> [136] 1733 1735 1736 1737 1739 1742 1745 1752 1754 1756 1758 1759 1768 1770 1771
#> [151] 1778 1785 1790 1793 1795 1796 1797 1799 1800 1805 1806 1807 1808 1821 1828
#> [166] 1833 1835 1837 1840 1841 1842 1848 1851 1852 1854 1855 1857 1876 1879 1880
#> [181] 1882 1883 1884 1887 1889 1894 1898 1899 1905 1906 1907 1908 1909 1912 1919
#> [196] 1926 1927 1930 1933 1934 1935 1936 1940 1952 1955 1956 1960 1962 1963 1966
#> [211] 1967 1969 1970 1976 1977 1978 1980 1985 1987 1990
```

```{r univariate-mean-and-or-variance-change-Rbeast, eval = FALSE}
Rbeast::beast(
  mv_data_1, season = "none", print.progress = FALSE, quiet = TRUE
)$trend$cp
#>  [1] 1301  301 1855 1794  701 1986 1981 1769 1859 1834
```

```{r univariate-mean-and-or-variance-change-mcp, eval = FALSE}
plot(
  mcp::mcp(
    list(y ~ 1, ~ 1, ~ 1, ~ 1, ~ 1, ~ 1),
    data = data.frame(y = mv_data_1, x = seq_len(nrow(mv_data_1))),
    par_x = "x"
  )
)
```

![`mcp` plot for univariate mean and/or variance change](comparison-packages-mv_data_1-mcp.svg)

```{r univariate-mean-and-or-variance-change-not}
plot(not::not(mv_data_1, contrast = "pcwsConstMeanVar"))
```

# Multivariate mean change

The true change points are 300 and 700.
Some methods are plotted due to the un-retrievable change points.

```{r multivariate-mean-change-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.mean(mean_data_3, r.progress = FALSE)@cp_set)
```

```{r multivariate-mean-change-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(300, 700))
```

```{r multivariate-mean-change-CptNonPar}
(CptNonPar_result <- CptNonPar::np.mojo(mean_data_3, G = floor(nrow(mean_data_3) / 6))$cpts)
```

```{r multivariate-mean-change-CptNonPar-testthat, include = FALSE}
testthat::expect_equal(CptNonPar_result, c(300, 700))
```

```{r multivariate-mean-change-InspectChangepoint, eval = FALSE}
invisible(
  suppressMessages(
    capture.output(
      result_InspectChangepoint <- InspectChangepoint::inspect(
        t(mean_data_3),
        threshold = InspectChangepoint::compute.threshold(
          nrow(mean_data_3), ncol(mean_data_3)
        )
      )
    )
  )
)
result_InspectChangepoint$changepoints[, "location"]
#> [1] 300 700
```

```{r multivariate-mean-change-jointseg}
(jointseg_result <- jointseg::jointSeg(mean_data_3, K = 2)$bestBkp)
```

```{r multivariate-mean-change-jointseg-testthat, include = FALSE}
testthat::expect_equal(jointseg_result, c(300, 700))
```

```{r multivariate-mean-change-Rbeast, eval = FALSE}
invisible(
  capture.output(
    result_Rbeast <- Rbeast::beast123(
      mean_data_3,
      metadata = list(whichDimIsTime = 1),
      season = "none"
    )
  )
)
result_Rbeast$trend$cp
#> Warning message:
#> In Rbeast::beast123(mean_data_3, metadata = list(whichDimIsTime = 1),  :
#>   WARNING: If the input data is regular and ordered in time,the times of individual datapoints are determined fully by 'metadata$startTime' and 'metadata$deltaTime'. But startTime and deltaTime are missing and a default value 1 is used for both!
#>       [,1] [,2] [,3]
#>  [1,]  301  301  701
#>  [2,]  701  701  301
#>  [3,]  NaN  225  NaN
#>  [4,]  NaN  684  NaN
#>  [5,]  NaN  NaN  NaN
#>  [6,]  NaN  NaN  NaN
#>  [7,]  NaN  NaN  NaN
#>  [8,]  NaN  NaN  NaN
#>  [9,]  NaN  NaN  NaN
#> [10,]  NaN  NaN  NaN
```

```{r multivariate-mean-change-strucchange, eval = FALSE}
strucchange::breakpoints(
  cbind(y.1, y.2, y.3) ~ 1, data = data.frame(y = mean_data_3)
)$breakpoints
#> [1] 300 700
```

```{r multivariate-mean-change-ecp, eval = FALSE}
ecp::e.divisive(mean_data_3)$estimates
#> [1]    1  301  701 1001
```

```{r multivariate-mean-change-bcp, eval = FALSE}
plot(bcp::bcp(mean_data_3))
```

![`bcp` plot for multivariate mean change](comparison-packages-mean_data_3-bcp.svg)

# Multivariate mean and/or variance change

The true change points are 300, 700, 1000, 1300 and 1700.
Some methods are plotted due to the un-retrievable change points.

```{r multivariate-mean-and-or-variance-change-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.mv(mv_data_3, r.progress = FALSE)@cp_set)
```

```{r multivariate-mean-and-or-variance-change-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(300, 700, 1000, 1300, 1700))
```

```{r multivariate-mean-and-or-variance-change-ecp, eval = FALSE}
ecp::e.divisive(mv_data_3)$estimates
#> [1]    1  301  701 1001 1301 1701 2001
```

```{r multivariate-mean-and-or-variance-change-InspectChangepoint, eval = FALSE}
invisible(
  suppressMessages(
    capture.output(
      result_InspectChangepoint <- InspectChangepoint::inspect(
        t(mv_data_3),
        threshold = InspectChangepoint::compute.threshold(
          nrow(mv_data_3), ncol(mv_data_3)
        )
      )
    )
  )
)
result_InspectChangepoint$changepoints[, "location"]
#>   [1]  300  700  701  703  704  705  707  708  710  711  712  714  715  716  717
#>  [16]  719  721  722  723  725  726  728  729  730  731  732  734  735  736  738
#>  [31]  739  740  741  742  744  745  747  748  749  752  753  754  756  757  759
#>  [46]  761  762  763  764  766  768  769  770  772  773  774  776  777  778  780
#>  [61]  781  783  784  786  788  789  791  793  795  797  799  800  801  803  805
#>  [76]  806  808  809  811  813  814  816  817  819  821  822  824  825  826  828
#>  [91]  829  830  831  832  834  835  837  838  839  841  842  843  845  846  847
#> [106]  852  853  855  857  860  861  862  864  865  866  868  869  870  871  873
#> [121]  876  877  878  880  882  883  884  886  888  891  893  895  896  898  900
#> [136]  901  903  904  905  906  908  909  910  911  914  915  916  919  920  921
#> [151]  923  924  926  927  928  930  931  933  934  936  938  939  940  942  944
#> [166]  945  946  948  949  951  952  954  956  957  959  960  961  962  964  965
#> [181]  966  968  969  970  971  973  974  976  977  979  980  982  983  984  985
#> [196]  986  988  989  990  992  993  995  996  998 1000 1300 1700 1701 1702 1705
#> [211] 1708 1710 1711 1712 1713 1715 1716 1717 1718 1720 1721 1724 1725 1726 1728
#> [226] 1729 1730 1731 1733 1734 1735 1737 1738 1740 1742 1743 1745 1747 1749 1750
#> [241] 1752 1753 1754 1755 1756 1758 1759 1760 1762 1763 1764 1766 1767 1769 1770
#> [256] 1771 1773 1774 1776 1777 1779 1780 1782 1783 1785 1787 1788 1790 1791 1792
#> [271] 1793 1794 1796 1798 1800 1801 1803 1805 1809 1811 1812 1813 1814 1816 1817
#> [286] 1819 1820 1821 1823 1824 1826 1828 1830 1832 1833 1834 1836 1838 1839 1841
#> [301] 1842 1843 1846 1847 1850 1851 1853 1854 1856 1857 1859 1861 1862 1864 1865
#> [316] 1866 1869 1870 1872 1874 1876 1878 1879 1881 1882 1883 1885 1887 1888 1889
#> [331] 1890 1892 1894 1896 1898 1899 1900 1902 1904 1905 1907 1908 1909 1911 1913
#> [346] 1914 1916 1918 1919 1920 1922 1923 1925 1926 1928 1930 1931 1933 1935 1936
#> [361] 1937 1939 1940 1942 1943 1945 1947 1948 1950 1951 1952 1953 1955 1956 1957
#> [376] 1959 1960 1961 1963 1964 1966 1967 1968 1970 1972 1974 1976 1977 1978 1979
#> [391] 1982 1983 1985 1987 1990 1992 1993 1994 1996 1997
```

```{r multivariate-mean-and-or-variance-change-Rbeast, eval = FALSE}
invisible(
  capture.output(
    result_Rbeast <- Rbeast::beast123(
      mv_data_3,
      metadata = list(whichDimIsTime = 1),
      season = "none"
    )
  )
)
result_Rbeast$trend$cp
#> Warning message:
#> In Rbeast::beast123(mv_data_3, metadata = list(whichDimIsTime = 1),  :
#>   WARNING: If the input data is regular and ordered in time,the times of individual datapoints are determined fully by 'metadata$startTime' and 'metadata$deltaTime'. But startTime and deltaTime are missing and a default value 1 is used for both!
#>       [,1] [,2] [,3]
#>  [1,] 1301  701  301
#>  [2,]  301  301 1301
#>  [3,]  701 1301  702
#>  [4,]  877  830 1924
#>  [5,] 1994  887 1880
#>  [6,] 1905  881 1971
#>  [7,] 1934  869  776
#>  [8,] 1929  807  831
#>  [9,] 1978 1960  845
#> [10,]  861 1947  760
```

# Linear regression

The true change points are 100 and 200.

```{r linear-regression-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.lm(lm_data, r.progress = FALSE)@cp_set)
```

```{r linear-regression-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(99, 201))
```

```{r linear-regression-strucchange, eval = FALSE}
strucchange::breakpoints(y ~ . - 1, data = lm_data)$breakpoints
#> [1] 100 201
```

```{r linear-regression-segmented}
(segmented_result <- segmented::segmented(
  lm(
    y ~ . - 1,
    data.frame(y = lm_data$y, x = lm_data[, -1], index = seq_len(nrow(lm_data)))
  ),
  seg.Z = ~ index
)$psi[, "Est."])
```

```{r linear-regression-segmented-testthat, include = FALSE}
testthat::expect_lt(segmented_result - 233, 1)
```

# Logistic regression

The true change point is 300.

```{r logistic-regression-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.binomial(binomial_data, r.progress = FALSE)@cp_set)
```

```{r logistic-regression-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(300))
```

```{r logistic-regression-strucchange, eval = FALSE}
strucchange::breakpoints(y ~ . - 1, data = binomial_data)$breakpoints
#> [1] 297
```

# Poisson regression

The true change points are 500, 800 and 1000.

```{r poisson-regression-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.poisson(poisson_data, r.progress = FALSE)@cp_set)
```

```{r poisson-regression-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(498, 800, 1003))
```

```{r poisson-regression-strucchange, eval = FALSE}
strucchange::breakpoints(y ~ . - 1, data = poisson_data)$breakpoints
#> [1] 935
```

# Lasso

The true change points are 80, 200 and 320.

```{r lasso-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.lasso(lasso_data, r.progress = FALSE)@cp_set)
```

```{r lasso-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(79, 199, 320))
```

```{r lasso-strucchange, eval = FALSE}
strucchange::breakpoints(y ~ . - 1, data = lasso_data)$breakpoints,
#> [1]  80 200 321
```

# AR(3)

The true change point is 600.
Some methods are plotted due to the un-retrievable change points.

```{r ar3-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.ar(ar_data, 3, r.progress = FALSE)@cp_set)
```

```{r ar3-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(614))
```

```{r ar3-CptNonPar}
(CptNonPar_result <- CptNonPar::np.mojo(ar_data, G = floor(length(ar_data) / 6))$cpts)
```

```{r ar3-CptNonPar-testthat, include = FALSE}
testthat::expect_equal(CptNonPar_result, numeric(0))
```

```{r ar3-segmented}
(segmented_result <- segmented::segmented(
  lm(
    y ~ x + 1, data.frame(y = ar_data, x = seq_along(ar_data))
  ),
  seg.Z = ~ x
)$psi[, "Est."])
```

```{r ar3-segmented-testthat, include = FALSE}
testthat::expect_equal(segmented_result, c(690))
```

```{r ar3-mcp, eval = FALSE}
plot(
  mcp::mcp(
    list(y ~ 1 + ar(3), ~ 0 + ar(3)),
    data = data.frame(y = ar_data, x = seq_along(ar_data)),
    par_x = "x"
  )
)
```

![`mcp` plot for AR(3)](comparison-packages-ar_data-mcp.svg)

# GARCH(1, 1)

The true change point is 200.

```{r garch11-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.garch(garch_data, c(1, 1), r.progress = FALSE)@cp_set)
```

```{r garch11-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(205))
```

```{r garch11-CptNonPar}
(CptNonPar_result <- CptNonPar::np.mojo(garch_data, G = floor(length(garch_data) / 6))$cpts)
```

```{r garch11-CptNonPar-testthat, include = FALSE}
testthat::expect_equal(CptNonPar_result, c(206))
```

```{r garch11-strucchange, eval = FALSE}
strucchange::breakpoints(x ~ 1, data = data.frame(x = garch_data))$breakpoints
#> [1] NA
```

# VAR(2)

The true change points is 500.

```{r var2-fastcpd}
(fastcpd_result <- fastcpd::fastcpd.var(
  var_data, 2, cost_adjustment = NULL, r.progress = FALSE
)@cp_set)
```

```{r var2-fastcpd-testthat, include = FALSE}
testthat::expect_equal(fastcpd_result, c(500))
```

```{r var2-VARDetect}
(VARDetect_result <- VARDetect::tbss(var_data)$cp)
```

```{r var2-VARDetect-testthat, include = FALSE}
testthat::expect_equal(VARDetect_result, c(501))
```

# Detection comparison using `well_log`

```{r detection-comparison-well-log, eval = FALSE}
result <- list(
  fastcpd = fastcpd.mean(well_log, trim = 0.003)@cp_set,
  changepoint = changepoint::cpt.mean(well_log)@cpts,
  CptNonPar =
    CptNonPar::np.mojo(well_log, G = floor(length(well_log) / 6))$cpts,
  strucchange = strucchange::breakpoints(
    y ~ 1, data = data.frame(y = well_log)
  )$breakpoints,
  ecp = ecp::e.divisive(matrix(well_log))$estimates,
  breakfast = breakfast::breakfast(well_log)$cptmodel.list[[6]]$cpts,
  wbs = wbs::wbs(well_log)$cpt$cpt.ic$mbic.penalty,
  mosum = mosum::mosum(c(well_log), G = 40)$cpts.info$cpts,
  fpop = fpop::Fpop(well_log, length(well_log))$t.est,  # meaningless
  gfpop = gfpop::gfpop(
    data = well_log,
    mygraph = gfpop::graph(
      penalty = 2 * log(length(well_log)) * gfpop::sdDiff(well_log) ^ 2,
      type = "updown"
    ),
    type = "mean"
  )$changepoints,
  InspectChangepoint = InspectChangepoint::inspect(
    well_log,
    threshold = InspectChangepoint::compute.threshold(length(well_log), 1)
  )$changepoints[, "location"],
  jointseg = jointseg::jointSeg(well_log, K = 12)$bestBkp,
  Rbeast = Rbeast::beast(
    well_log, season = "none", print.progress = FALSE, quiet = TRUE
  )$trend$cp,
  stepR = stepR::stepFit(well_log, alpha = 0.5)$rightEnd
)

package_list <- sort(names(result), decreasing = TRUE)
comparison_table <- NULL
for (package_index in seq_along(package_list)) {
  package <- package_list[[package_index]]
  comparison_table <- rbind(
    comparison_table,
    data.frame(
      change_point = result[[package]],
      package = package,
      y_offset = (package_index - 1) * 400
    )
  )
}

most_selected <- sort(table(comparison_table$change_point), decreasing = TRUE)
most_selected <- sort(as.numeric(names(most_selected[most_selected >= 4])))
for (i in seq_len(length(most_selected) - 1)) {
  if (most_selected[i + 1] - most_selected[i] < 2) {
    most_selected[i] <- NA
    most_selected[i + 1] <- most_selected[i + 1] - 0.5
  }
}
(most_selected <- most_selected[!is.na(most_selected)])
#>  [1]    6.0  314.0  434.0  704.0  776.0 1021.0 1057.0 1347.0 1405.0 1502.0 1661.0 1842.0 2023.0 2202.0
#> [15] 2384.5 2445.0 2507.0 2567.5 2738.0 2921.0 3094.0 3251.0 3464.0 3499.0 3622.0 3709.0 3820.0 3976.0
```

```{r detection-comparison-well-log-plot, eval = FALSE}
ggplot2::ggplot() +
  ggplot2::geom_point(
    data = data.frame(x = seq_along(well_log), y = c(well_log)),
    ggplot2::aes(x = x, y = y)
  ) +
  ggplot2::geom_vline(
    xintercept = most_selected,
    color = "black",
    linetype = "dashed",
    alpha = 0.2
  ) +
  ggplot2::geom_point(
    data = comparison_table,
    ggplot2::aes(x = change_point, y = 95000 + y_offset, color = package),
    shape = 17,
    size = 1.75
  ) +
  ggplot2::geom_hline(
    data = comparison_table,
    ggplot2::aes(yintercept = 95000 + y_offset, color = package),
    linetype = "dashed",
    alpha = 0.1
  ) +
  ggplot2::coord_cartesian(
    ylim = c(95000 - 500, max(well_log) + 1000),
    xlim = c(-200, length(well_log) + 200),
    expand = FALSE
  ) +
  ggplot2::theme(
    panel.background = ggplot2::element_blank(),
    panel.border = ggplot2::element_rect(colour = "black", fill = NA),
    panel.grid.major = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank()
  ) +
  ggplot2::xlab(NULL) + ggplot2::ylab(NULL)
```

![Plot of the detection using `well_log` data](comparison-packages-well_log-cpts.svg)

# Time comparison using `well_log`

```{r time-comparison-well-log, eval = FALSE}
microbenchmark_result <- microbenchmark::microbenchmark(
  fastcpd = fastcpd::fastcpd.mean(well_log, trim = 0.003, r.progress = FALSE),
  changepoint = changepoint::cpt.mean(well_log, method = "PELT"),
  CptNonPar = CptNonPar::np.mojo(well_log, G = floor(length(well_log) / 6)),
  strucchange =
    strucchange::breakpoints(y ~ 1, data = data.frame(y = well_log)),
  ecp = ecp::e.divisive(matrix(well_log)),
  breakfast = breakfast::breakfast(well_log),
  wbs = wbs::wbs(well_log),
  mosum = mosum::mosum(c(well_log), G = 40),
  fpop = fpop::Fpop(well_log, nrow(well_log)),
  gfpop = gfpop::gfpop(
    data = well_log,
    mygraph = gfpop::graph(
      penalty = 2 * log(length(well_log)) * gfpop::sdDiff(well_log) ^ 2,
      type = "updown"
    ),
    type = "mean"
  ),
  InspectChangepoint = InspectChangepoint::inspect(
    well_log,
    threshold = InspectChangepoint::compute.threshold(length(well_log), 1)
  ),
  jointseg = jointseg::jointSeg(well_log, K = 12),
  Rbeast = Rbeast::beast(
    well_log, season = "none", print.progress = FALSE, quiet = TRUE
  ),
  stepR = stepR::stepFit(well_log, alpha = 0.5),
  not = not::not(well_log, contrast = "pcwsConstMean"),
  times = 10
)
#> Unit: milliseconds
#>                expr          min           lq         mean       median           uq          max neval
#>             fastcpd 8.411284e+01 8.692226e+01 1.011440e+02 1.044509e+02 1.089672e+02    118.05842    10
#>         changepoint 3.206773e+01 3.377081e+01 6.843465e+01 3.857181e+01 5.243834e+01    244.76672    10
#>           CptNonPar 1.827381e+04 1.901094e+04 2.002752e+04 1.985180e+04 2.076803e+04  22511.59316    10
#>         strucchange 5.955079e+04 6.059315e+04 6.185727e+04 6.131291e+04 6.312073e+04  64638.93090    10
#>                 ecp 7.590543e+05 7.707573e+05 7.859080e+05 7.830752e+05 8.093015e+05 810339.52140    10
#>           breakfast 9.170992e+03 9.344041e+03 9.628236e+03 9.382078e+03 9.628663e+03  11073.79318    10
#>                 wbs 1.139078e+02 1.145472e+02 1.178167e+02 1.166746e+02 1.201676e+02    127.27064    10
#>               mosum 1.172847e+00 1.231747e+00 1.740727e+01 1.416854e+00 1.919586e+00    160.76997    10
#>                fpop 2.588228e+00 2.630407e+00 4.587742e+00 2.832556e+00 3.312986e+00     18.52067    10
#>               gfpop 5.971245e+01 6.072684e+01 6.533492e+01 6.172578e+01 6.839653e+01     87.89407    10
#>  InspectChangepoint 1.698673e+02 1.909034e+02 2.392539e+02 2.117010e+02 3.004474e+02    329.87724    10
#>            jointseg 2.000894e+01 2.136878e+01 2.551210e+01 2.167757e+01 2.403593e+01     47.98397    10
#>              Rbeast 6.533998e+02 6.625203e+02 6.783586e+02 6.792646e+02 6.875840e+02    723.45376    10
#>               stepR 2.793709e+01 2.902084e+01 4.380857e+01 3.068416e+01 3.227125e+01    164.81082    10
#>                 not 9.599763e+01 9.701856e+01 1.028601e+02 1.012292e+02 1.049974e+02    120.73529    10
```

```{r time-comparison-well-log-plot, eval = FALSE}
ggplot2::autoplot(microbenchmark_result)
```

![Plot of the running time using `well_log` data](comparison-packages-well_log-time.svg)

# Related issues

-   `mosum`: [[#4](https://github.com/doccstat/fastcpd/issues/4)].
-   `mcp`: [link 1](https://github.com/doccstat/fastcpd/actions/runs/7272426093/job/19814531091)
    and [link 2](https://github.com/doccstat/fastcpd/actions/runs/7272426093/job/19814531284).
-   `bcp`: [[#5](https://github.com/doccstat/fastcpd/issues/5)].
-   `gfpop`: [[#10](https://github.com/doccstat/fastcpd/issues/10)].

# Appendix: all code snippets

```{r ref.label = knitr::all_labels(), echo = TRUE, eval = FALSE}
```
